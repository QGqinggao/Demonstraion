## 一、核心模块设计

### 1.1 configs - 静态配置层

- **核心类**：
	- -` CardResConfig`: 卡牌视图配置。
	- -`ConstValueConfig`: 一些常用常量配置。
	- -`LevelConfig`: 关卡配置。
	- -`LevelConfigLoader`: 关卡配置加载器。

### 1.2 models - 数据模型层

- **核心类**：
	- -`CardModel`: 卡牌核心数据类型。
	- -`GameModel`: 游戏整体数据。
	- -`UndoModel`: 回退数据。

### 1.3 views - 视图层

- **核心类**：
    - `CardView`：卡牌视图组件，负责渲染与交互。
    - `PlayFieldView`：主牌区视图，管理所有主牌区`CardView`。
    - -`StackView`: 堆牌区视图，管理所有堆牌区 `CardView`。
    - - `GameView`：游戏主视图，整合所有子视图。
        

### 1.4 controllers - 控制器层

- **核心类**：
    - `GameController`：游戏主控制器，协调各模块。
    - `PlayFieldController`:  桌面牌区控制器，管理桌面牌区视图和桌面牌。
    - `StackController`: 手牌区控制器，管理手牌区视图和手牌。
    - `CardController`: 卡牌控制器，每个卡牌均有属于每个卡牌的实例。
### 1.5 managers - 管理器层

- **核心类**：
    - `UndoManager`：回退管理器，负责记录操作历史与回退。


### 1.6 services/- 服务层

- **核心类**：
    - `GameModelFromLevelGenerator`：游戏模型生成服务，根据关卡文件生成 `GameModel` 。
    
## 二、核心功能实现

### 2.1 手牌区翻牌替换（需求 1）

1. **交互流程**：

    - 用户点击手牌区可替换卡牌（如♥A）→ `CardView`捕获点击→ 回调通知`CardController`。
	- `CardController`检查合法性→ 通知`StackController` 执行`handleCardClick` 方法 → 通知`GameController` 执行 `handleStackCardClick` 方法 。
	- 由 `GameController` 调用`StackController` 执行 `replaceTrayWithStack` 方法 并调用`UndoManager` 记录操作前状态。
    - `StackController` 调用 `CardView` 执行动画：♥A 平移至原顶部牌（♣4）位置并替换。
    
### 2.2 桌面牌与手牌匹配（需求 2）

1. **交互流程**：

    -  用户点击桌面牌可替换卡牌（如♦3）→ `CardView`捕获点击→ 回调通知`CardController`。
	- `CardController`检查合法性→ 通知`PlayFieldView` 执行`handleCardClick` 方法 → 通知`GameController` 执行 `handlePlayFieldViewCardClick` 方法 。
	- `GameController` 通过判断：♦3（点数 3）与底牌顶部♣4（点数 4）点数差 1→ 符合规则。
	- 由 `GameController` 调用`PlayFieldView` 执行 `replaceTrayWithPlayFieldView 方法 并调用`UndoManager` 记录操作前状态。
    - `PlayFieldView` 调用 `CardView` 执行动画：♦3 平移至底牌区替换♣4。
### 2.3 回退功能（需求 3）

1. **交互流程**：
    
    - 用户点击回退按钮 → 回退按钮捕获点击 → 回调通知 `UndoManager` → `UndoManager` 通过事件告知 `GameController` 执行 `handleUndo` 方法。
    - `GameController` 进行回退操作。
    - 视图执行反向动画（按原路径回退）。
    
## 三、可扩展性设计

### 3.1 新增卡牌类型

1. **添加新卡牌**：

	若要想在关卡初始化时添加新卡牌，可以直接在 `GameModelFromLevelGenerator` 中的`generatorGameModel`直接修改` levelConfig` 参数。
	
	或者更新文件夹 `Resources/configs/levels/`中的关卡配置`json` 文件（更推荐）。
		关卡文件的读取采用的是字符串拼接的形式，在 `LevelConfig_` 之后拼接关卡 `levelId` 即可。
    
2. **添加新类型回退功能**：
    
    (1) 新回退类型数据结构添加：在 `UndoModel.h` 文件下新增需要添加类型的 `···Record` 并将其添加到 `UndoStep` 中新增 `std::vector<Record>` 记录。
    (2) 回退数据添加：在需要回退数据的模块中声明 `UndoStep` 和 `Record` 类型，通过 `UndoManager` 添加到 `UndoModel` 中。
    (3) 回退操作执行：需要进行回退操作执行的类注册回调函数并通过`UndoManager::setUndoCallback` 方法绑定，并由 `UndoManager::undoLastStep` 方法进行一次回退操作执行。 
    